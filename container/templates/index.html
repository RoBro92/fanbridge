<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FanBridge</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --thbg:#f6f8fa; --pillbg:#fafafa; --cardbg:#ffffff; }
    body.dark { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --border:#334155; --thbg:#111827; --pillbg:#1f2937; --cardbg:#0b1220; }
    body { background: var(--bg); color: var(--fg); }
    .muted { color: var(--muted); }
    table, th, td { border-color: var(--border); }
    th { background: var(--thbg); }
    .pill { border:1px solid var(--border); border-radius:999px; padding:3px 10px; background:var(--pillbg); font-size: 12px; color: var(--fg); }
    button { padding:6px 10px; border:1px solid var(--border); background:var(--pillbg); border-radius:6px; cursor:pointer; color: var(--fg); }
    button:hover { filter: brightness(1.05); }
    a { color: inherit; text-decoration: underline; }
    h1 { margin: 0 0 8px; }
    .meta { color: #666; margin-bottom: 16px; }

    table { border-collapse: collapse; width: 100%; max-width: 905px; }
    th, td { border: 1px solid; padding: 8px 10px; text-align: left; }

    .ok   { color: #0a7;   font-weight: 600; }
    .warn { color: #d97706; font-weight: 600; }
    .crit { color: #d32;   font-weight: 700; }

    .flex { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .pill.warn { border-color:#f59e0b; background:#fff7ed; color:#92400e; }
    .small { font-size: 12px; }
    .right { float:right; }
    .footer { margin-top: 16px; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }

    .panel { border:1px solid var(--border); border-radius:8px; padding:12px; background: var(--cardbg); max-width: 880px; margin-top:16px; }
    .panel h2 { margin:0 0 8px; font-size:16px; }
    .chk { display:inline-flex; align-items:center; gap:6px; margin:6px 12px 6px 0; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:6px 12px; }
    .inputs { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type="number"] { width: 72px; padding:4px 6px; }

    /* Centre + tighten specific columns */
    th.type,  td.type  { text-align: center; width: 90px; }
    th.state, td.state { text-align: center; width: 90px; }
    th.temp,  td.temp  { text-align: center; width: 110px; }
    th.inc,   td.inc   { text-align: center; width: 90px; }
    td.inc { text-align:center; }
    input.incl { transform: scale(1.3); accent-color: #16a34a; }

    .grid#curveH_th, .grid#curveH_pw, .grid#curveS_th, .grid#curveS_pw { grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); }
    .grid#curveH_th input, .grid#curveH_pw input, .grid#curveS_th input, .grid#curveS_pw input { width: 64px; }
    .rowlabel { min-width: 110px; }

    /* Form controls follow theme */
    input, select {
      background: var(--cardbg);
      color: var(--fg);
      border: 1px solid var(--border);
      color-scheme: light;
    }
    body.dark input, body.dark select { color-scheme: dark; }

    /* Improve visibility of number input arrows in dark mode (WebKit/Blink) */
    body.dark input[type="number"]::-webkit-outer-spin-button,
    body.dark input[type="number"]::-webkit-inner-spin-button {
      opacity: 1 !important;
      filter: invert(1) brightness(1.8) contrast(2) drop-shadow(0 0 0.5px #000);
    }

    input[disabled], select[disabled] { opacity: .75; }

    /* Ensure temp cells don't inherit odd backgrounds in dark mode */
    td.temp.ok, td.temp.warn, td.temp.crit { background: transparent !important; text-shadow: none; }

    /* Unraid-style gradient brand title */
    .brand {
      background: linear-gradient(90deg, #e53935 0%, #ff7043 35%, #ff9800 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }
  </style>
</head>
<body data-poll="{{ poll_s|int }}" data-version="{{ version or '—' }}">
  <h1 class="brand">FanBridge for Unraid</h1>

  <div class="meta flex">
    <span id="ver"   class="pill">version: {{ version or "—" }}</span>
    <span class="pill">refresh: every {{ poll_s }}s</span>
    <span id="mtime" class="pill">disks.ini: …</span>
    <span class="small muted" id="updated">last update: …</span>
    <button id="themeToggle" class="pill" type="button">Theme: …</button>
    <span id="dirtyFlag" class="pill warn" style="display:none;">Unsaved changes</span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Device</th>
        <th class="type">Type</th>
        <th class="state">State</th>
        <th class="temp">Temp (°C)</th>
        <th class="inc">Included</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="5" class="muted">Loading…</td></tr>
    </tbody>
    <tfoot>
      <tr>
        <th colspan="5">
          HDD avg/min/max: <span id="hddstats" class="small muted">—</span> &nbsp; | &nbsp;
          SSD avg/min/max: <span id="ssdstats" class="small muted">—</span> &nbsp; | &nbsp;
          Recommended PWM: <strong id="pwm">—</strong>
        </th>
      </tr>
    </tfoot>
  </table>

  <div class="panel">
    <h1>Configuration</h1>

    <h2>Single Drive Max Overrides</h2>
    <div class="inputs">
      <label>HDD  (°C): <input type="number" id="hddovr" min="30" max="70" step="1"></label>
      <label>SSD  (°C): <input type="number" id="ssdovr" min="40" max="90" step="1"></label>
      <button id="savebtn">Save</button>
      <button id="discardbtn" style="display:none;">Discard</button>
    </div>

    <h2 style="margin-bottom:8px;">Fan curves</h2>
    <div class="small muted" style="margin-bottom:10px;">
      Set the fan curve from temperature to PWM. Left to right = increasing temperature.
    </div>

    <h2 style="margin:6px 0 6px;">HDD fan curve</h2>
    <div class="inputs" style="align-items:flex-start;">
      <div class="rowlabel small muted" style="width:130px;">Thresholds (°C)</div>
      <div class="grid" id="curveH_th"></div>
    </div>
    <div class="inputs" style="align-items:flex-start; margin-top:6px;">
      <div class="rowlabel small muted" style="width:130px;">PWM (%)</div>
      <div class="grid" id="curveH_pw"></div>
    </div>

    <h2 style="margin:12px 0 6px;">SSD fan curve</h2>
    <div class="inputs" style="align-items:flex-start;">
      <div class="rowlabel small muted" style="width:130px;">Thresholds (°C)</div>
      <div class="grid" id="curveS_th"></div>
    </div>
    <div class="inputs" style="align-items:flex-start; margin-top:6px;">
      <div class="rowlabel small muted" style="width:130px;">PWM (%)</div>
      <div class="grid" id="curveS_pw"></div>
    </div>

    <div class="inputs" style="margin-top:10px;">
      <button id="savecurves">Save</button>
      <button id="discardcurves" style="display:none;">Discard</button>
    </div>
  </div>

  <div class="footer small muted">
    <a href="/api/status">API</a> &nbsp;|&nbsp; <a href="/health">Health</a>
  </div>

  <script>
    const POLL_MS = (parseInt(document.body.dataset.poll || '7', 10)) * 1000;
    const fmt = (v) => (v === null || v === undefined) ? "—" : v;

    // dynamic colour class based on per-type override thresholds
    let OVERRIDE_HDD = 45;
    let OVERRIDE_SSD = 60;
    const WARN_DELTA = 5; // orange when within 5°C of override
    let HTH = [], HPW = [], STH = [], SPW = [];
    let DIRTY_OVR = false;   // overrides edited but not saved
    let DIRTY_CURVES = false; // fan curves edited but not saved

    function setDirty(which, v=true){
      if(which === 'ovr') DIRTY_OVR = v; else if(which === 'curves') DIRTY_CURVES = v;
      const any = DIRTY_OVR || DIRTY_CURVES;
      document.getElementById('dirtyFlag').style.display = any ? '' : 'none';
      document.getElementById('discardbtn').style.display = DIRTY_OVR ? '' : 'none';
      document.getElementById('discardcurves').style.display = DIRTY_CURVES ? '' : 'none';
    }

    const clsForTemp = (t, type) => {
      if (t === null || t === undefined) return "muted";
      const thr = (String(type).toUpperCase() === 'SSD') ? OVERRIDE_SSD : OVERRIDE_HDD;
      if (t >= thr) return "crit";
      if (t >= (thr - WARN_DELTA)) return "warn";
      return "ok";
    };

    async function refresh() {
      try {
        const r = await fetch('/api/status', { cache: 'no-store' });
        const j = await r.json();

        const VERSION_FALLBACK = document.body.dataset.version || '—';
        document.getElementById('ver').textContent = 'version: ' + (j.version || VERSION_FALLBACK);
        document.getElementById('pwm').textContent = (j.recommended_pwm ?? '—') + '%';

        const now = new Date();
        document.getElementById('updated').textContent = 'last update: ' + now.toLocaleString();
        const mt = j.disks_ini_mtime ? new Date(j.disks_ini_mtime * 1000).toLocaleTimeString() : 'n/a';
        document.getElementById('mtime').textContent = 'disks.ini: ' + mt;

        // sync dynamic thresholds from server so colours reflect current settings
        if (typeof j.override_hdd_c === 'number') OVERRIDE_HDD = j.override_hdd_c;
        if (typeof j.override_ssd_c === 'number') OVERRIDE_SSD = j.override_ssd_c;
        if (Array.isArray(j.hdd_thresholds)) HTH = j.hdd_thresholds.slice();
        if (Array.isArray(j.hdd_pwm)) HPW = j.hdd_pwm.slice();
        if (Array.isArray(j.ssd_thresholds)) STH = j.ssd_thresholds.slice();
        if (Array.isArray(j.ssd_pwm)) SPW = j.ssd_pwm.slice();

        const rows = document.getElementById('rows');
        rows.innerHTML = '';
        (j.drives || []).forEach(d => {
          const tr = document.createElement('tr');
          const tdDev = document.createElement('td'); tdDev.textContent = d.dev ? (d.slot ? (d.dev + ' (' + d.slot + ')') : d.dev) : '—';
          const tdType = document.createElement('td'); tdType.textContent = d.type || '—'; tdType.className = 'type';
          const tdState = document.createElement('td'); tdState.textContent = d.state || '—'; tdState.className = 'state';
          const tdTemp = document.createElement('td'); tdTemp.textContent = fmt(d.temp); tdTemp.className = 'temp ' + clsForTemp(d.temp, d.type);
          const tdInc = document.createElement('td'); tdInc.className = 'inc';

          const cbInc = document.createElement('input');
          cbInc.type = 'checkbox';
          cbInc.className = 'incl';
          cbInc.checked = !d.excluded; // checked means INCLUDED in calculations
          cbInc.onchange = async (e) => {
            try {
              await fetch('/api/exclude', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dev: d.dev, excluded: !e.target.checked })
              });
            } catch (err) { console.error(err); }
          };
          tdInc.appendChild(cbInc);

          tr.append(tdDev, tdType, tdState, tdTemp, tdInc);
          rows.appendChild(tr);
        });

        const hs = j.hdd || {}, ss = j.ssd || {};
        document.getElementById('hddstats').textContent = (fmt(hs.avg) + ' / ' + fmt(hs.min) + ' / ' + fmt(hs.max) + '  (n=' + fmt(hs.count) + ')');
        document.getElementById('ssdstats').textContent = (fmt(ss.avg) + ' / ' + fmt(ss.min) + ' / ' + fmt(ss.max) + '  (n=' + fmt(ss.count) + ')');

        // populate override inputs only if not being edited (dirty)
        if (!DIRTY_OVR) {
          if (typeof j.override_hdd_c !== 'undefined') document.getElementById('hddovr').value = j.override_hdd_c;
          if (typeof j.override_ssd_c !== 'undefined') document.getElementById('ssdovr').value = j.override_ssd_c;
        }

        // populate fan curve editors (skip if user is editing to prevent overwrites)
        if (!DIRTY_CURVES) {
          const ch_th = document.getElementById('curveH_th'); ch_th.innerHTML='';
          const ch_pw = document.getElementById('curveH_pw'); ch_pw.innerHTML='';
          const cs_th = document.getElementById('curveS_th'); cs_th.innerHTML='';
          const cs_pw = document.getElementById('curveS_pw'); cs_pw.innerHTML='';

          const makeNum = (val)=>{ const i=document.createElement('input'); i.type='number'; i.min='0'; i.max='100'; i.step='1'; i.value = val; i.addEventListener('input', ()=> setDirty('curves', true)); return i; };

          const nH = Math.max(HTH.length, HPW.length) || 1;
          const nS = Math.max(STH.length, SPW.length) || 1;
          ch_th.style.gridTemplateColumns = `repeat(${nH}, minmax(70px, 1fr))`;
          ch_pw.style.gridTemplateColumns = `repeat(${nH}, minmax(70px, 1fr))`;
          cs_th.style.gridTemplateColumns = `repeat(${nS}, minmax(70px, 1fr))`;
          cs_pw.style.gridTemplateColumns = `repeat(${nS}, minmax(70px, 1fr))`;

          for (let i=0;i<nH;i++) { ch_th.appendChild(makeNum(HTH[i]!==undefined?HTH[i]:0)); ch_pw.appendChild(makeNum(HPW[i]!==undefined?HPW[i]:0)); }
          for (let i=0;i<nS;i++) { cs_th.appendChild(makeNum(STH[i]!==undefined?STH[i]:0)); cs_pw.appendChild(makeNum(SPW[i]!==undefined?SPW[i]:0)); }
        }
      } catch (e) {
        console.error(e);
      }
    }

    refresh();
    setInterval(refresh, POLL_MS);

    document.getElementById('hddovr').addEventListener('input', ()=> setDirty('ovr', true));
    document.getElementById('ssdovr').addEventListener('input', ()=> setDirty('ovr', true));

    document.getElementById('savebtn').addEventListener('click', async () => {
      const h = parseInt(document.getElementById('hddovr').value, 10);
      const s = parseInt(document.getElementById('ssdovr').value, 10);
      try {
        await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            single_override_hdd_c: isNaN(h) ? undefined : h,
            single_override_ssd_c: isNaN(s) ? undefined : s
          })
        });
        setDirty('ovr', false);
        refresh();
      } catch (err) { console.error(err); }
    });

    document.getElementById('savecurves').addEventListener('click', async () => {
      const ch_th = document.getElementById('curveH_th').querySelectorAll('input');
      const ch_pw = document.getElementById('curveH_pw').querySelectorAll('input');
      const cs_th = document.getElementById('curveS_th').querySelectorAll('input');
      const cs_pw = document.getElementById('curveS_pw').querySelectorAll('input');
      const HTH2 = Array.from(ch_th).map(i => parseInt(i.value||'0',10));
      const HPW2 = Array.from(ch_pw).map(i => parseInt(i.value||'0',10));
      const STH2 = Array.from(cs_th).map(i => parseInt(i.value||'0',10));
      const SPW2 = Array.from(cs_pw).map(i => parseInt(i.value||'0',10));
      try {
        await fetch('/api/curves', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hdd_thresholds: HTH2, hdd_pwm: HPW2, ssd_thresholds: STH2, ssd_pwm: SPW2 })
        });
        setDirty('curves', false);
        refresh();
      } catch (err) { console.error(err); }
    });

    document.getElementById('discardbtn').addEventListener('click', ()=> { setDirty('ovr', false); refresh(); });
    document.getElementById('discardcurves').addEventListener('click', ()=> { setDirty('curves', false); refresh(); });

    // ---- Theme toggle (light/dark) ----
    const THEME_KEY = 'fanbridgeTheme';
    function applyTheme(t){
      const dark = (t === 'dark');
      document.body.classList.toggle('dark', dark);
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = 'Theme: ' + (dark ? 'Dark' : 'Light');
      try { localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light'); } catch(e) {}
    }
    (function(){
      let pref = 'light';
      try {
        pref = localStorage.getItem(THEME_KEY) ||
          (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      } catch(e) {}
      applyTheme(pref);
      const tbtn = document.getElementById('themeToggle');
      if (tbtn) tbtn.addEventListener('click', ()=> {
        const next = document.body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(next);
      });
    })();
  </script>
</body>
</html>